# GitHub Actions workflow for iOS cloud build using Capacitor and Xcode
# This workflow builds the iOS app and exports an IPA artifact.
# Requirements:
# - Your repo must be public, or you must use a paid GitHub plan for macOS runners.
# - You must provide your own Apple Developer credentials for code signing (manual or automatic).

name: Build iOS App

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli

      - name: Add iOS platform (if needed)
        run: npx cap add ios || echo 'iOS already added'

      - name: Build web assets
        run: npm run build

      - name: Add iOS platform (if needed)
        run: npx cap add ios || echo 'iOS already added'

      - name: Sync Capacitor
        run: npx cap sync ios


      - name: Install CocoaPods dependencies
        run: |
          cd ios/App
          pod install

      - name: Build iOS app with Xcode
        run: |
          cd ios/App
          xcodebuild -workspace App.xcworkspace -scheme App -configuration Release -sdk iphoneos -archivePath ${{ github.workspace }}/Pontaj.xcarchive archive

      - name: Copy ExportOptions.plist to ios/App
        run: cp ${{ github.workspace }}/ExportOptions.plist ios/App/ExportOptions.plist

      - name: Export IPA
        run: |
          cd ios/App
          xcodebuild -exportArchive -archivePath ${{ github.workspace }}/Pontaj.xcarchive -exportOptionsPlist ExportOptions.plist -exportPath ${{ github.workspace }}/output

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pontaj-iOS-IPA
          path: ios/output/*.ipa

# Note:
# - You must provide a valid ExportOptions.plist in the ios/ directory for code signing.
# - For App Store/TestFlight upload, you need to set up secrets for Apple credentials and add upload steps.
# - For ad-hoc/device testing, register device UDIDs in your Apple Developer account and configure provisioning.
